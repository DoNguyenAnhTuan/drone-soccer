<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B·∫£ng Thi ƒê·∫•u Drone Soccer</title>
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
    <img src="../images/logo-left.png" alt="Logo Tr√°i" class="logo-left">
    <img src="../images/logo-right.png" alt="Logo Ph·∫£i" class="logo-right">

    <h1>B·∫£ng Thi ƒê·∫•u Drone Soccer EIU - V√≤ng 1-8</h1>
    <button onclick="randomizeMatches()">üé≤ X√°o Tr·ªôn ƒê·ªôi</button>
    <button onclick="resetScores()">üîÑ Reset ƒêi·ªÉm</button>
    <div class="container" id="matches-container"></div>
    <button id="nextRoundButton" class="hidden" onclick="goToBackRound()">‚¨Ö L√πi l·∫°i V√≤ng B·∫£ng</button>
    <button id="nextRoundButton" class="hidden" onclick="goToNextRound()">‚û° Ti·∫øn t·ªõi T·ª© k·∫øt</button>
    <script>

        // L·∫•y ch·ªâ t√™n ƒë·ªôi t·ª´ danh s√°ch ƒë·ªëi t∆∞·ª£ng
        let teamsData = JSON.parse(localStorage.getItem("123")) || [];
        let teams = teamsData.map(team => team.name); // Ch·ªâ l·∫•y thu·ªôc t√≠nh name
        let matches = [];

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                let j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        function randomizeMatches() {
            let savedMatches = localStorage.getItem("matches");

            // X√≥a d·ªØ li·ªáu c≈© trong localStorage tr∆∞·ªõc khi x√°o tr·ªôn
            localStorage.removeItem("matches"); // X√≥a d·ªØ li·ªáu c≈©
    
            if (savedMatches) {
                matches = JSON.parse(savedMatches);
                renderMatches();
                return; // Kh√¥ng x√°o tr·ªôn n·∫øu c√≥ d·ªØ li·ªáu c≈©
            }
            
            if (teams.length === 16) {
                shuffle(teams);
            } else {
                alert("L·ªói: Kh√¥ng t√¨m th·∫•y danh s√°ch ƒë·ªôi t·ª´ v√≤ng b·∫£ng.");
                return;
            }

            shuffle(teams);
            matches = [];
            let matchesContainer = document.getElementById("matches-container");
            matchesContainer.innerHTML = "";

            for (let i = 0; i < teams.length; i += 2) {
                let match = {
                    team1: teams[i],
                    team2: teams[i + 1],
                    score1: [0, 0, 0], // 3 tr·∫≠n
                    score2: [0, 0, 0],
                    foul1: [0, 0, 0], // S·ªë l·ªói ph·∫°m c·ªßa ƒë·ªôi 1
                    foul2: [0, 0, 0], // S·ªë l·ªói ph·∫°m c·ªßa ƒë·ªôi 2
                    totalPoints1: 0,
                    totalPoints2: 0,
                    totalScore1: 0,
                    totalScore2: 0,
                    totalFoul1: 0,
                    totalFoul2: 0
                };
                matches.push(match);
            }
            saveToLocalStorage(); // L∆∞u tr·∫°ng th√°i hi·ªán t·∫°i
            renderMatches();
        }
        function updateScore(matchIndex, gameIndex, team, value) {
            let match = matches[matchIndex];
            value = parseInt(value) || 0;

            if (team === 1) {
                match.score1[gameIndex] = value;
            } else {
                match.score2[gameIndex] = value;
            }
            
            calculateResults(matchIndex);
        }
        function updateFoul(matchIndex, gameIndex, team, value) {
            let match = matches[matchIndex];
            value = parseInt(value) || 0;

            if (team === 1) {
                match.foul1[gameIndex] = value;
            } else {
                match.foul2[gameIndex] = value;
            }
            
            calculateResults(matchIndex);
        }
        function calculateResults(matchIndex) {
            let match = matches[matchIndex];
            match.totalPoints1 = 0;
            match.totalPoints2 = 0;
            match.totalScore1 = 0;
            match.totalScore2 = 0;
            match.totalFoul1 = 0;
            match.totalFoul2 = 0;

            for (let i = 0; i < 1; i++) {
                match.totalScore1 += match.score1[i];
                match.totalScore2 += match.score2[i];
                match.totalFoul1 += match.foul1[i];
                match.totalFoul2 += match.foul2[i];

                if (match.score1[i] > match.score2[i]) match.totalPoints1 += 3;
                if (match.score1[i] < match.score2[i]) match.totalPoints2 += 3;
                if (match.score1[i] === match.score2[i]) {
                    match.totalPoints1 += 1;
                    match.totalPoints2 += 1;
                }
            }
            saveToLocalStorage(); // L∆∞u d·ªØ li·ªáu khi c·∫≠p nh·∫≠t ƒëi·ªÉm

            renderMatches();
        }
        function goToBackRound() {
            
            window.location.href = "24.html";
        }
        function renderMatches() {
                    let matchesContainer = document.getElementById("matches-container");
                    matchesContainer.innerHTML = "";

                    matches.forEach((match, index) => {
                        let scoreInputs = "";
                        let foulInputs = "";
                        for (let i = 0; i < 1; i++) {
                            scoreInputs += `
                                <input type="number" class="score-input red-border" value="${match.score1[i]}" 
                                    oninput="updateScore(${index}, ${i}, 1, this.value)">
                                -
                                <input type="number" class="score-input blue-border" value="${match.score2[i]}" 
                                    oninput="updateScore(${index}, ${i}, 2, this.value)">
                                <br>
                            `;

                            foulInputs += `
                                <input type="number" class="score-input red-border" value="${match.foul1[i]}" 
                                    oninput="updateFoul(${index}, ${i}, 1, this.value)">
                                -
                                <input type="number" class="score-input blue-border" value="${match.foul2[i]}" 
                                    oninput="updateFoul(${index}, ${i}, 2, this.value)">
                                <br>
                            `;
                        }

                        let winnerText = `<br><b>X√©t t·ªïng ƒëi·ªÉm: ${match.totalPoints1} - ${match.totalPoints2}</b>`;
                        if (match.totalPoints1 > match.totalPoints2) {
                            winnerText += `<br><b>${match.team1} V√†o V√≤ng T·ª© k·∫øt! üèÜ</b>`;
                        } else if (match.totalPoints1 < match.totalPoints2) {
                            winnerText += `<br><b>${match.team2} V√†o V√≤ng T·ª© k·∫øt! üèÜ</b>`;
                        } else {
                            // winnerText += `<br><b>X√©t s·ªë l·ªói: ${match.totalFoul1} - ${match.totalFoul2}</b>`;
                            // winnerText += match.totalFoul1 > match.totalFoul2 ? `<br><b>${match.team2} V√†o V√≤ng T·ª© k·∫øt! üèÜ</b>` : `<br><b>${match.team1} V√†o V√≤ng T·ª© k·∫øt! üèÜ</b>`;
                            if (match.totalFoul1 < match.totalFoul2) {
                                winnerText += `<br><b>${match.team1} V√†o V√≤ng T·ª© k·∫øt! üèÜ</b>`;
                            } else if (match.totalFoul1 > match.totalFoul2) {
                                winnerText += `<br><b>${match.team2} V√†o V√≤ng T·ª© k·∫øt! üèÜ</b>`;
                            } else {
                                winnerText += `<br><b>K·∫øt qu·∫£ h√≤a sau 2 tr·∫≠n! üö®</b><br><b>C·∫ßn x√©t ti√™u ch√≠ ph·ª• ho·∫∑c ƒë·∫•u l·∫°i.</b>`;
                            }
                        }

                        matchesContainer.innerHTML += `<div class="match-box"><div class="match-title">Tr·∫≠n ${index + 13}</div>${match.team1} üÜö ${match.team2}<br><br>ƒêi·ªÉm s·ªë:<br>${scoreInputs}<br>Ph·∫°m l·ªói:<br>${foulInputs}${winnerText}</div>`;
                    });
                }
        function checkAndShowNextButton() {
            let allMatchesCompleted = matches.every(match => match.totalPoints1 !== 0 || match.totalPoints2 !== 0);
            document.getElementById("nextRoundButton").classList.toggle("hidden", !allMatchesCompleted);
        }
        function goToNextRound() {
            let winners = matches.map(match => match.totalPoints1 > match.totalPoints2 || 
                (match.totalPoints1 === match.totalPoints2 && match.totalFoul1 < match.totalFoul2) ? match.team1 : match.team2);
            
            localStorage.setItem("16", JSON.stringify(winners));
            window.location.href = "2_8.html";
        }
        function resetScores() {
                    matches.forEach(match => {
                        match.score1 = [0, 0, 0];
                        match.score2 = [0, 0, 0];
                        match.foul1 = [0, 0, 0];
                        match.foul2 = [0, 0, 0];
                        match.totalPoints1 = 0;
                        match.totalPoints2 = 0;
                        match.totalScore1 = 0;
                        match.totalScore2 = 0;
                        match.totalFoul1 = 0;
                        match.totalFoul2 = 0;
                    });

                    saveToLocalStorage(); // L∆∞u d·ªØ li·ªáu sau reset
                    renderMatches();
                }
        function saveToLocalStorage() {
            localStorage.setItem("matches", JSON.stringify(matches));
        }
        function loadFromLocalStorage() {
            let savedMatches = localStorage.getItem("matches");
            if (savedMatches) {
                matches = JSON.parse(savedMatches);
                renderMatches();
            }
        }
        randomizeMatches();
    </script>
</body>
</html>
