<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Báº£ng Thi Äáº¥u Drone Soccer - Chung káº¿t</title>
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
    <img src="../images/logo-left.png" alt="Logo TrÃ¡i" class="logo-left">
    <img src="../images/logo-right.png" alt="Logo Pháº£i" class="logo-right">
    <h1>Báº£ng Thi Äáº¥u Drone Soccer - Chung káº¿t</h1>
    <button onclick="randomizeMatches()">ğŸ² XÃ¡o Trá»™n Äá»™i</button>
    <button onclick="resetScores()">ğŸ”„ Reset Äiá»ƒm</button>
    <div class="container" id="matches-container"></div>
    <!-- <button id="nextRoundButton" class="hidden" onclick="goToNextRound()">â¡ Danh sÃ¡ch cÃ¡c Ä‘á»™i tháº¯ng cuá»™c</button> -->
    <button id="nextRoundButton" class="hidden" onclick="goToBackRound()">â¬… LÃ¹i láº¡i VÃ²ng Tranh 3-4</button>
    <button id="showResultsButton" onclick="showResults()">ğŸ† Xem Thá»© Háº¡ng</button>
    <div id="results-container" style="display:none; margin-top: 20px;">
        <h2>ğŸ–ï¸ Danh sÃ¡ch xáº¿p háº¡ng:</h2>
        <p id="rank1"></p>
        <p id="rank2"></p>
        <p id="rank3"></p>
        <p id="rank4"></p>
    </div>
    <script>
        let teams = JSON.parse(localStorage.getItem("winners5")) || [];
        let thirdPlaceTeams = JSON.parse(localStorage.getItem("winners3")) || []; // Láº¥y Ä‘á»™i háº¡ng 3-4 tá»« 34.html

        let matches = [];
        
        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                let j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }      
        function randomizeMatches() {
            if (teams.length === 2) {
                shuffle(teams);
            } else {
                alert("Lá»—i: KhÃ´ng tÃ¬m tháº¥y danh sÃ¡ch Ä‘á»™i tá»« vÃ²ng bÃ¡n káº¿t.");
            }

            matches = [];
            let matchesContainer = document.getElementById("matches-container");
            matchesContainer.innerHTML = "";

            for (let i = 0; i < teams.length; i += 2) {
                let match = {
                    team1: teams[i],
                    team2: teams[i + 1],
                    score1: [0, 0, 0], // 3 tráº­n
                    score2: [0, 0, 0],
                    foul1: [0, 0, 0], // Sá»‘ lá»—i pháº¡m cá»§a Ä‘á»™i 1
                    foul2: [0, 0, 0], // Sá»‘ lá»—i pháº¡m cá»§a Ä‘á»™i 2
                    totalPoints1: 0,
                    totalPoints2: 0,
                    totalScore1: 0,
                    totalScore2: 0,
                    totalFoul1: 0,
                    totalFoul2: 0
                };
                matches.push(match);
            }

            renderMatches();
        }
        function updateScore(matchIndex, gameIndex, team, value) {
            let match = matches[matchIndex];
            value = parseInt(value) || 0;

            if (team === 1) {
                match.score1[gameIndex] = value;
            } else {
                match.score2[gameIndex] = value;
            }
            
            calculateResults(matchIndex);
        }
        function updateFoul(matchIndex, gameIndex, team, value) {
            let match = matches[matchIndex];
            value = parseInt(value) || 0;

            if (team === 1) {
                match.foul1[gameIndex] = value;
            } else {
                match.foul2[gameIndex] = value;
            }
            
            calculateResults(matchIndex);
        }
        function calculateResults(matchIndex) {
            let match = matches[matchIndex];
            match.totalPoints1 = 0;
            match.totalPoints2 = 0;
            match.totalScore1 = 0;
            match.totalScore2 = 0;
            match.totalFoul1 = 0;
            match.totalFoul2 = 0;

            for (let i = 0; i < 2; i++) {
                const s1 = match.score1[i];
                const s2 = match.score2[i];
                const f1 = match.foul1[i];
                const f2 = match.foul2[i];

                match.totalScore1 += s1;
                match.totalScore2 += s2;
                match.totalFoul1 += f1;
                match.totalFoul2 += f2;

                if (s1 > s2) {
                    match.totalPoints1 += 3;
                } else if (s2 > s1) {
                    match.totalPoints2 += 3;
                } else {
                    // HÃ²a Ä‘iá»ƒm â†’ xÃ©t lá»—i
                    if (f1 < f2) {
                        match.totalPoints1 += 3;
                    } else if (f2 < f1) {
                        match.totalPoints2 += 3;
                    } else {
                        // HÃ²a lá»—i â†’ chia Ä‘iá»ƒm
                        match.totalPoints1 += 1;
                        match.totalPoints2 += 1;
                    }
                }
            }

            // Xá»­ lÃ½ tráº­n 3 Golden Goal náº¿u sau 2 tráº­n tá»•ng Ä‘iá»ƒm báº±ng nhau
            const g3_1 = match.score1[2];
            const g3_2 = match.score2[2];
            if (match.totalPoints1 === match.totalPoints2) {
                if (g3_1 > g3_2) {
                    match.totalPoints1 += 1;
                } else if (g3_2 > g3_1) {
                    match.totalPoints2 += 1;
                }
                // náº¿u chÆ°a ai ghi bÃ n Golden Goal thÃ¬ giá»¯ nguyÃªn
            }

            // saveToLocalStorage(); // LÆ°u dá»¯ liá»‡u khi cáº­p nháº­t Ä‘iá»ƒm
            renderMatches();
        }
        function renderMatches() {
            let matchesContainer = document.getElementById("matches-container");
            matchesContainer.innerHTML = "";

            matches.forEach((match, index) => {
                let scoreInputs = "";
                let foulInputs = "";
                for (let i = 0; i < 2; i++) {
                    const team1Class = i % 2 === 0 ? "red-border" : "blue-border";
                    const team2Class = i % 2 === 0 ? "blue-border" : "red-border";

                    scoreInputs += `
                        <input type="number" class="score-input ${team1Class}" value="${match.score1[i]}" 
                            oninput="updateScore(${index}, ${i}, 1, this.value)">
                        -
                        <input type="number" class="score-input ${team2Class}" value="${match.score2[i]}" 
                            oninput="updateScore(${index}, ${i}, 2, this.value)">
                        <br>
                    `;

                    foulInputs += `
                        <input type="number" class="score-input ${team1Class}" value="${match.foul1[i]}" 
                            oninput="updateFoul(${index}, ${i}, 1, this.value)">
                        -
                        <input type="number" class="score-input ${team2Class}" value="${match.foul2[i]}" 
                            oninput="updateFoul(${index}, ${i}, 2, this.value)">
                        <br>
                    `;
                }

                let goldenGoalInputs = "";
                let winnerText = `<br><b>XÃ©t tá»•ng Ä‘iá»ƒm: ${match.totalPoints1} - ${match.totalPoints2}</b>`;

                // Kiá»ƒm tra cÃ³ cáº§n Ä‘Ã¡ tráº­n 3 (Golden Goal) khÃ´ng
                let needGoldenGoal = (
                    match.score1[0] !== 0 || match.score2[0] !== 0 ||
                    match.score1[1] !== 0 || match.score2[1] !== 0
                ) && match.totalPoints1 === match.totalPoints2;

                if (needGoldenGoal || (match.score1[2] > 0 || match.score2[2] > 0)) {
                    // LuÃ´n hiá»ƒn thá»‹ Ã´ nháº­p tráº­n 3 náº¿u cáº§n hoáº·c náº¿u Ä‘Ã£ nháº­p tráº­n 3
                    const g3_1 = match.score1[2];
                    const g3_2 = match.score2[2];

                    goldenGoalInputs = `
                        <br><b>Thi Ä‘áº¥u Tráº­n 3 - Golden Goal!</b><br>
                        <input type="number" class="score-input blue-border" value="${g3_1}" 
                            oninput="updateScore(${index}, 2, 1, this.value)">
                        -
                        <input type="number" class="score-input red-border" value="${g3_2}" 
                            oninput="updateScore(${index}, 2, 2, this.value)">
                    `;

                    if (g3_1 > g3_2) {
                        winnerText += `<br><b>${match.team1} VÃ´ Ä‘á»‹ch! ğŸ†</b>`;
                    } else if (g3_2 > g3_1) {
                        winnerText += `<br><b>${match.team2} VÃ´ Ä‘á»‹ch! ğŸ†</b>`;
                    } else {
                        winnerText += `<br><i>ChÆ°a cÃ³ bÃ n tháº¯ng Golden Goal!</i>`;
                    }
                } else {
                    // Xá»­ lÃ½ káº¿t quáº£ bÃ¬nh thÆ°á»ng
                    if (match.totalPoints1 > match.totalPoints2) {
                        winnerText += `<br><b>${match.team1} VÃ´ Ä‘á»‹ch! ğŸ†</b>`;
                    } else if (match.totalPoints2 > match.totalPoints1) {
                        winnerText += `<br><b>${match.team2} VÃ´ Ä‘á»‹ch! ğŸ†</b>`;
                    }
                }

                matchesContainer.innerHTML += `
                    <div class="match-box">
                        <div class="match-title">Tráº­n ${index + 21}</div>
                        ${match.team1} ğŸ†š ${match.team2}<br><br>
                        Äiá»ƒm sá»‘:<br>${scoreInputs}
                        Pháº¡m lá»—i:<br>${foulInputs}
                        ${goldenGoalInputs}
                        ${winnerText}
                    </div>
                `;
            });
        }
        function checkAndShowNextButton() {
            let allMatchesCompleted = matches.every(match => match.totalPoints1 !== 0 || match.totalPoints2 !== 0);
            document.getElementById("nextRoundButton").classList.toggle("hidden", !allMatchesCompleted);
        }
        function goToBackRound() {
            window.location.href = "4_34.html";
        }
        function showResults() {
            let match = matches[0]; 
            let rank1, rank2;

            if (match.totalPoints1 > match.totalPoints2) {
                rank1 = match.team1;
                rank2 = match.team2;
            } else if (match.totalPoints1 < match.totalPoints2) {
                rank1 = match.team2;
                rank2 = match.team1;
            } else {
                rank1 = match.totalFoul1 < match.totalFoul2 ? match.team1 : match.team2;
                rank2 = match.totalFoul1 > match.totalFoul2 ? match.team1 : match.team2;
            }

            let thirdPlaceTeams = JSON.parse(localStorage.getItem("winners4")) || [];
            let rank3 = thirdPlaceTeams[0]; // Háº¡ng 3
            let rank4 = thirdPlaceTeams[1]; // Háº¡ng 4

            let resultsHTML = `
                <div class="results-container">
                    <h2>ğŸ–ï¸ Danh sÃ¡ch xáº¿p háº¡ng:</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Háº¡ng</th>
                                <th>TÃªn Äá»™i</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>ğŸ¥‡ Háº¡ng 1</td>
                                <td><b>${rank1}</b></td>
                            </tr>
                            <tr>
                                <td>ğŸ¥ˆ Háº¡ng 2</td>
                                <td><b>${rank2}</b></td>
                            </tr>
                            <tr>
                                <td>ğŸ¥‰ Háº¡ng 3</td>
                                <td><b>${rank3}</b></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById("results-container").innerHTML = resultsHTML;
            document.getElementById("results-container").style.display = "block";
        }
        randomizeMatches();
    </script>
</body>
</html>
