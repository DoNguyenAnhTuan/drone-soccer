<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B·∫£ng Thi ƒê·∫•u Drone Soccer - B√°n k·ªÉt</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <img src="images/logo-left.png" alt="Logo Tr√°i" class="logo-left">
    <img src="images/logo-right.png" alt="Logo Ph·∫£i" class="logo-right">
    <h1>B·∫£ng Thi ƒê·∫•u Drone Soccer - V√≤ng B√°n k·∫øt</h1>
    <button onclick="randomizeMatches()">üé≤ X√°o Tr·ªôn ƒê·ªôi</button>
    <button onclick="resetScores()">üîÑ Reset ƒêi·ªÉm</button>
    <div class="container" id="matches-container"></div>
    <button id="nextRoundButton" class="hidden" onclick="goToBackRound()">‚¨Ö L√πi l·∫°i V√≤ng T·ª© K·∫øt</button>
    <button id="nextRoundButton" class="hidden" onclick="goToNextRound()">‚û° Ti·∫øn t·ªõi Tr·∫≠n Tranh 3-4</button>
    <script>
        // let teams = [
        //     "ƒê·ªôi 1", "ƒê·ªôi 2", "ƒê·ªôi 3", "ƒê·ªôi 4", 
        //     "ƒê·ªôi 5", "ƒê·ªôi 6", "ƒê·ªôi 7", "ƒê·ªôi 8"
        // ];
        let teams = JSON.parse(localStorage.getItem("winners1")) || [];

        let matches = [];
        
        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                let j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        function randomizeMatches() {
            let savedMatches = localStorage.getItem("matches2");
            // X√≥a d·ªØ li·ªáu c≈© trong localStorage tr∆∞·ªõc khi x√°o tr·ªôn
            localStorage.removeItem("matches2"); // X√≥a d·ªØ li·ªáu c≈©
    
            if (savedMatches) {
                matches = JSON.parse(savedMatches);
                renderMatches();
                return; // Kh√¥ng x√°o tr·ªôn n·∫øu c√≥ d·ªØ li·ªáu c≈©
            }
            if (teams.length === 4) {
                shuffle(teams);
            } else {
                alert("L·ªói: Kh√¥ng t√¨m th·∫•y danh s√°ch ƒë·ªôi t·ª´ v√≤ng 8.");
                return;
            }

            matches = [];
            let matchesContainer = document.getElementById("matches-container");
            matchesContainer.innerHTML = "";

            for (let i = 0; i < teams.length; i += 2) {
                let match = {
                    team1: teams[i],
                    team2: teams[i + 1],
                    score1: [0, 0, 0], // 3 tr·∫≠n
                    score2: [0, 0, 0],
                    foul1: [0, 0, 0], // S·ªë l·ªói ph·∫°m c·ªßa ƒë·ªôi 1
                    foul2: [0, 0, 0], // S·ªë l·ªói ph·∫°m c·ªßa ƒë·ªôi 2
                    totalPoints1: 0,
                    totalPoints2: 0,
                    totalScore1: 0,
                    totalScore2: 0,
                    totalFoul1: 0,
                    totalFoul2: 0
                };
                matches.push(match);
            }
            saveToLocalStorage(); // L∆∞u l·∫°i tr·∫≠n ƒë·∫•u m·ªõi
            renderMatches();
        }
        function updateScore(matchIndex, gameIndex, team, value) {
            let match = matches[matchIndex];
            value = parseInt(value) || 0;

            if (team === 1) {
                match.score1[gameIndex] = value;
            } else {
                match.score2[gameIndex] = value;
            }
            
            calculateResults(matchIndex);
        }
        function updateFoul(matchIndex, gameIndex, team, value) {
            let match = matches[matchIndex];
            value = parseInt(value) || 0;

            if (team === 1) {
                match.foul1[gameIndex] = value;
            } else {
                match.foul2[gameIndex] = value;
            }
            
            calculateResults(matchIndex);
        }
        function calculateResults(matchIndex) {
            let match = matches[matchIndex];
            match.totalPoints1 = 0;
            match.totalPoints2 = 0;
            match.totalScore1 = 0;
            match.totalScore2 = 0;
            match.totalFoul1 = 0;
            match.totalFoul2 = 0;

            for (let i = 0; i < 2; i++) {
                const s1 = match.score1[i];
                const s2 = match.score2[i];
                const f1 = match.foul1[i];
                const f2 = match.foul2[i];

                match.totalScore1 += s1;
                match.totalScore2 += s2;
                match.totalFoul1 += f1;
                match.totalFoul2 += f2;

                if (s1 > s2) {
                    match.totalPoints1 += 3;
                } else if (s2 > s1) {
                    match.totalPoints2 += 3;
                } else {
                    // H√≤a ƒëi·ªÉm ‚Üí x√©t l·ªói
                    if (f1 < f2) {
                        match.totalPoints1 += 3;
                    } else if (f2 < f1) {
                        match.totalPoints2 += 3;
                    } else {
                        // H√≤a l·ªói ‚Üí chia ƒëi·ªÉm
                        match.totalPoints1 += 1;
                        match.totalPoints2 += 1;
                    }
                }
            }

            // X·ª≠ l√Ω tr·∫≠n 3 Golden Goal n·∫øu sau 2 tr·∫≠n t·ªïng ƒëi·ªÉm b·∫±ng nhau
            const g3_1 = match.score1[2];
            const g3_2 = match.score2[2];
            if (match.totalPoints1 === match.totalPoints2) {
                if (g3_1 > g3_2) {
                    match.totalPoints1 += 1;
                } else if (g3_2 > g3_1) {
                    match.totalPoints2 += 1;
                }
                // n·∫øu ch∆∞a ai ghi b√†n Golden Goal th√¨ gi·ªØ nguy√™n
            }

            saveToLocalStorage(); // L∆∞u d·ªØ li·ªáu khi c·∫≠p nh·∫≠t ƒëi·ªÉm
            renderMatches();
        }
        function renderMatches() {
            let matchesContainer = document.getElementById("matches-container");
            matchesContainer.innerHTML = "";

            matches.forEach((match, index) => {
                let scoreInputs = "";
                let foulInputs = "";
                for (let i = 0; i < 2; i++) {
                    const team1Class = i % 2 === 0 ? "red-border" : "blue-border";
                    const team2Class = i % 2 === 0 ? "blue-border" : "red-border";

                    scoreInputs += `
                        <input type="number" class="score-input ${team1Class}" value="${match.score1[i]}" 
                            oninput="updateScore(${index}, ${i}, 1, this.value)">
                        -
                        <input type="number" class="score-input ${team2Class}" value="${match.score2[i]}" 
                            oninput="updateScore(${index}, ${i}, 2, this.value)">
                        <br>
                    `;

                    foulInputs += `
                        <input type="number" class="score-input ${team1Class}" value="${match.foul1[i]}" 
                            oninput="updateFoul(${index}, ${i}, 1, this.value)">
                        -
                        <input type="number" class="score-input ${team2Class}" value="${match.foul2[i]}" 
                            oninput="updateFoul(${index}, ${i}, 2, this.value)">
                        <br>
                    `;
                }

                let goldenGoalInputs = "";
                let winnerText = `<br><b>X√©t t·ªïng ƒëi·ªÉm: ${match.totalPoints1} - ${match.totalPoints2}</b>`;

                // Ki·ªÉm tra c√≥ c·∫ßn ƒë√° tr·∫≠n 3 (Golden Goal) kh√¥ng
                let needGoldenGoal = (
                    match.score1[0] !== 0 || match.score2[0] !== 0 ||
                    match.score1[1] !== 0 || match.score2[1] !== 0
                ) && match.totalPoints1 === match.totalPoints2;

                if (needGoldenGoal || (match.score1[2] > 0 || match.score2[2] > 0)) {
                    // Lu√¥n hi·ªÉn th·ªã √¥ nh·∫≠p tr·∫≠n 3 n·∫øu c·∫ßn ho·∫∑c n·∫øu ƒë√£ nh·∫≠p tr·∫≠n 3
                    const g3_1 = match.score1[2];
                    const g3_2 = match.score2[2];

                    goldenGoalInputs = `
                        <br><b>Thi ƒë·∫•u Tr·∫≠n 3 - Golden Goal!</b><br>
                        <input type="number" class="score-input blue-border" value="${g3_1}" 
                            oninput="updateScore(${index}, 2, 1, this.value)">
                        -
                        <input type="number" class="score-input red-border" value="${g3_2}" 
                            oninput="updateScore(${index}, 2, 2, this.value)">
                    `;

                    if (g3_1 > g3_2) {
                        winnerText += `<br><b>${match.team1} Th·∫Øng Golden Goal! üèÜ</b>`;
                    } else if (g3_2 > g3_1) {
                        winnerText += `<br><b>${match.team2} Th·∫Øng Golden Goal! üèÜ</b>`;
                    } else {
                        winnerText += `<br><i>Ch∆∞a c√≥ b√†n th·∫Øng Golden Goal!</i>`;
                    }
                } else {
                    // X·ª≠ l√Ω k·∫øt qu·∫£ b√¨nh th∆∞·ªùng
                    if (match.totalPoints1 > match.totalPoints2) {
                        winnerText += `<br><b>${match.team1} V√†o V√≤ng Chung K·∫øt! üèÜ</b>`;
                    } else if (match.totalPoints2 > match.totalPoints1) {
                        winnerText += `<br><b>${match.team2} V√†o V√≤ng Chung K·∫øt! üèÜ</b>`;
                    }
                }

                matchesContainer.innerHTML += `
                    <div class="match-box">
                        <div class="match-title">Tr·∫≠n ${index + 21}</div>
                        ${match.team1} üÜö ${match.team2}<br><br>
                        ƒêi·ªÉm s·ªë:<br>${scoreInputs}
                        Ph·∫°m l·ªói:<br>${foulInputs}
                        ${goldenGoalInputs}
                        ${winnerText}
                    </div>
                `;
            });
        }
        function checkAndShowNextButton() {
            let allMatchesCompleted = matches.every(match => match.totalPoints1 !== 0 || match.totalPoints2 !== 0);
            document.getElementById("nextRoundButton").classList.toggle("hidden", !allMatchesCompleted);
        }
        function goToNextRound() {
            let winners2 = matches.map(match => match.totalPoints1 < match.totalPoints2 || 
                (match.totalPoints1 === match.totalPoints2 && match.totalFoul1 > match.totalFoul2) ? match.team1 : match.team2);
            
            localStorage.setItem("winners2", JSON.stringify(winners2));
            
            let winners5 = matches.map(match => match.totalPoints1 > match.totalPoints2 || 
                (match.totalPoints1 === match.totalPoints2 && match.totalFoul1 > match.totalFoul2) ? match.team1 : match.team2);
            
            localStorage.setItem("winners5", JSON.stringify(winners5));

            window.location.href = "4_34.html";
        }
        function goToBackRound() {
            window.location.href = "2_8.html";
        }
        function resetScores() {
            matches.forEach(match => {
                match.score1 = [0, 0, 0];
                match.score2 = [0, 0, 0];
                match.foul1 = [0, 0, 0];
                match.foul2 = [0, 0, 0];
                match.totalPoints1 = 0;
                match.totalPoints2 = 0;
                match.totalScore1 = 0;
                match.totalScore2 = 0;
                match.totalFoul1 = 0;
                match.totalFoul2 = 0;
            });

            saveToLocalStorage(); // L∆∞u d·ªØ li·ªáu sau reset
            renderMatches();
        }
        function saveToLocalStorage() {
            localStorage.setItem("matches2", JSON.stringify(matches));
        }
        function loadFromLocalStorage() {
            let savedMatches = localStorage.getItem("matches2");
            if (savedMatches) {
                matches = JSON.parse(savedMatches);
                renderMatches();
            }
        }
        randomizeMatches();
    </script>
</body>
</html>
